@model Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Order
@using Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models
@{
    ViewData["Title"] = ViewData["Title"]?.ToString();
    var categories  = (List<Category>)ViewBag.Categories;
    var isOpen      = Model.OrderStatus == "open";
    var minutesOpen = (int)(DateTime.UtcNow - Model.OrderOpenedAt).TotalMinutes;
    var totalPaid   = Model.Payments?.Sum(p => p.PaymentsAmount) ?? 0;
    var remaining   = Model.OrderTotalAmount - totalPaid;

    var activeItems = Model.OrderItems.Where(i => i.OrderItemStatus != "cancelled").ToList();
    var unpaidItems = activeItems.Where(i => i.PaidQuantity < i.OrderItemQuantity).ToList();
    var paidItems   = activeItems.Where(i => i.PaidQuantity >= i.OrderItemQuantity).ToList();
    var paidTotal   = activeItems.Sum(i => i.PaidLineTotal);

    string StatusClass(string s) => s switch { "preparing" => "s-preparing", "served" => "s-served", "cancelled" => "s-cancelled", _ => "s-pending" };
    string StatusLabel(string s) => s switch { "preparing" => "Hazırlanıyor", "served" => "Servis Edildi", "cancelled" => "İptal", _ => "Bekliyor" };
    string PayMethodLabel(int m) => m switch { 1 => "💳 Kredi Kartı", 2 => "🏦 Banka Kartı", 3 => "🔄 Diğer", _ => "💵 Nakit" };
}

@section Styles {
    <link href="~/css/Views/Home/Detail.css" rel="stylesheet" asp-append-version="true" />
}

@if (TempData["Success"] != null) { <div class="alert alert-success">✅ @TempData["Success"]</div> }
@if (TempData["Error"]   != null) { <div class="alert alert-error">❌ @TempData["Error"]</div> }

<div class="page-header">
    <div>
        <h1 class="page-title">@Model.Table?.TableName — Adisyon #@Model.OrderId</h1>
        <p class="page-sub">
            @if (isOpen) { <span>Açık adisyon · @minutesOpen dakikadır açık</span> }
            else         { <span>Kapatıldı · @Model.OrderClosedAt?.ToLocalTime().ToString("dd MMM yyyy, HH:mm")</span> }
        </p>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
        <a asp-controller="Orders" asp-action="Index" class="back-btn">← Siparişler</a>
        @if (isOpen) { <button class="btn-pay" style="width:auto;padding:8px 18px" onclick="openModal('payModal')">💳 Ödeme Al</button> }
    </div>
</div>

<div class="detail-layout">

    <div class="left-panel">

        @* Adisyon Bilgileri *@
        <div class="info-card">
            <div><div class="info-item-label">Masa</div>   <div class="info-item-value">🪑 @Model.Table?.TableName</div></div>
            <div><div class="info-item-label">Garson</div> <div class="info-item-value">👤 @Model.OrderOpenedBy</div></div>
            <div><div class="info-item-label">Açılış</div> <div class="info-item-value">🕐 @Model.OrderOpenedAt.ToLocalTime().ToString("HH:mm")</div></div>
            <div><div class="info-item-label">Süre</div>   <div class="info-item-value">⏱ @minutesOpen dk</div></div>
            <div><div class="info-item-label">Durum</div>  <div class="info-item-value"><span class="status-badge @(isOpen?"s-preparing":"s-paid")">@(isOpen?"Açık":"Ödendi")</span></div></div>
            <div><div class="info-item-label">Toplam</div> <div class="info-item-value accent">₺@Model.OrderTotalAmount.ToString("N2")</div></div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.OrderNote))
        {
            <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:13px 18px;font-size:13px;color:var(--text-muted);">
                📝 <strong style="color:var(--text)">Not:</strong> @Model.OrderNote
            </div>
        }

        @* ╔══════════════════════════════════════════════════════════╗
           ║  TABLO 1 — Ödenecek Kalemler                           ║
           ╚══════════════════════════════════════════════════════════╝ *@
        <div class="panel">
            <div class="panel-head">
                <span class="panel-title">🧾 Sipariş Kalemleri</span>
                <span style="font-size:12px;color:var(--text-muted)">@unpaidItems.Count kalem ödenecek</span>
            </div>

            @if (!unpaidItems.Any())
            {
                <div style="padding:20px 16px;text-align:center;color:#22c55e;font-size:13px;font-weight:600;">
                    ✅ Tüm kalemler ödendi
                </div>
            }

            @foreach (var item in unpaidItems)
            {
                bool partial = item.PaidQuantity > 0;
                <div class="item-row">
                    <div class="item-info">
                        <div class="item-name">@item.MenuItem?.MenuItemName</div>
                        @if (partial) { <div class="item-sub">✓ @item.PaidQuantity adet ödendi</div> }
                        @if (!string.IsNullOrWhiteSpace(item.OrderItemNote)) { <div class="item-note">📝 @item.OrderItemNote</div> }
                    </div>
                    <div class="item-qty rem">×@item.RemainingQuantity</div>
                    <div class="item-price-col">
                        @if (partial)
                        {
                            <div class="item-price-unpaid">₺@item.UnpaidLineTotal.ToString("N2")</div>
                            <div class="item-price-sub">+₺@item.PaidLineTotal.ToString("N2") ödendi</div>
                        }
                        else
                        {
                            <div class="item-price">₺@item.OrderItemLineTotal.ToString("N2")</div>
                        }
                    </div>
                    @if (isOpen)
                    {
                        <div class="status-flow">
                            <span class="sflow-current @StatusClass(item.OrderItemStatus)">@StatusLabel(item.OrderItemStatus)</span>
                            @if (item.OrderItemStatus == "pending")
                            {
                                <span class="sflow-arrow">→</span>
                                <form asp-controller="Orders" asp-action="UpdateItemStatus" method="post" style="display:inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="orderItemId" value="@item.OrderItemId" />
                                    <input type="hidden" name="newStatus"   value="preparing" />
                                    <input type="hidden" name="orderId"     value="@Model.OrderId" />
                                    <button type="submit" class="sflow-btn sflow-btn-prepare">Hazırlıyor</button>
                                </form>
                            }
                            else if (item.OrderItemStatus == "preparing")
                            {
                                <span class="sflow-arrow">→</span>
                                <form asp-controller="Orders" asp-action="UpdateItemStatus" method="post" style="display:inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="orderItemId" value="@item.OrderItemId" />
                                    <input type="hidden" name="newStatus"   value="served" />
                                    <input type="hidden" name="orderId"     value="@Model.OrderId" />
                                    <button type="submit" class="sflow-btn sflow-btn-serve">Servis Et ✓</button>
                                </form>
                            }
                        </div>
                    }
                    else
                    {
                        <span class="status-badge @StatusClass(item.OrderItemStatus)">@StatusLabel(item.OrderItemStatus)</span>
                    }
                </div>
            }

            @if (isOpen && totalPaid > 0)
            {
                <div style="padding:10px 16px;background:var(--surface2);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                    <span style="font-weight:600">Kalan (ödenmemiş)</span>
                    <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--accent)">₺@remaining.ToString("N2")</span>
                </div>
            }
        </div>

        @* ╔══════════════════════════════════════════════════════════╗
           ║  TABLO 2 — Ödenen Kalemler  (yalnızca varsa görünür)   ║
           ╚══════════════════════════════════════════════════════════╝ *@
        @if (paidItems.Any())
        {
            <div class="panel panel-paid">
                <div class="panel-head">
                    <span class="panel-title">✓ Ödenen Kalemler</span>
                    <span style="font-size:12px;color:#22c55e;font-weight:600;">
                        @paidItems.Count kalem · ₺@paidItems.Sum(i => i.OrderItemLineTotal).ToString("N2")
                    </span>
                </div>
                @foreach (var item in paidItems)
                {
                    <div class="item-row paid-row">
                        <div class="item-info">
                            <div class="item-name" style="text-decoration:line-through;color:var(--text-muted)">
                                @item.MenuItem?.MenuItemName
                            </div>
                        </div>
                        <div class="item-qty">×@item.OrderItemQuantity</div>
                        <div class="item-price-col">
                            <div class="item-price" style="color:#22c55e">₺@item.OrderItemLineTotal.ToString("N2")</div>
                        </div>
                        <span class="status-badge s-paid">Ödendi</span>
                    </div>
                }
            </div>
        }

        @* ── Ürün Ekle ── *@
        @if (isOpen)
        {
            <div class="panel">
                <div class="panel-head">
                    <span class="panel-title">➕ Ürün Ekle</span>
                    <span style="font-size:11px;color:var(--text-muted)">Ürüne tıklayın</span>
                </div>
                <div class="add-panel-body">
                    @foreach (var cat in categories)
                    {
                        <div class="add-cat-header">
                            <div class="add-cat-stripe"></div>
                            <span class="add-cat-name">@cat.CategoryName</span>
                        </div>
                        <div class="add-items-wrap">
                            @foreach (var mi in cat.MenuItems)
                            {
                                <div class="add-item-row"
                                     onclick="openAddItemModal(@mi.MenuItemId, '@Html.Raw(mi.MenuItemName.Replace("'","\\'"))', @mi.MenuItemPrice.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))">
                                    <span class="ai-name">@mi.MenuItemName</span>
                                    <span class="ai-price">₺@mi.MenuItemPrice.ToString("N2")</span>
                                    <button type="button" class="ai-btn">＋</button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

    </div>

    @* ── SAĞ PANEL ── *@
    <div class="pay-panel">
        <div class="pay-head"><div class="pay-title">Ödeme Durumu</div></div>
        <div class="pay-summary">
            <div class="pay-row"><span class="pay-label">Adisyon Toplamı</span><span class="pay-value">₺@Model.OrderTotalAmount.ToString("N2")</span></div>
            @if (totalPaid > 0)
            {
                <div class="pay-row"><span class="pay-label">Ödenen</span><span class="pay-value" style="color:#22c55e">₺@totalPaid.ToString("N2")</span></div>
                <div class="pay-divider"></div>
                <div class="pay-total-row"><span class="pay-total-label">Kalan</span><span class="pay-remaining">₺@remaining.ToString("N2")</span></div>
            }
            else
            {
                <div class="pay-divider"></div>
                <div class="pay-total-row"><span class="pay-total-label">Toplam</span><span class="pay-total-value">₺@Model.OrderTotalAmount.ToString("N2")</span></div>
            }
        </div>
        @if (Model.Payments?.Any() == true)
        {
            @foreach (var p in Model.Payments.OrderBy(p => p.PaymentsPaidAt))
            {
                <div class="payment-record">
                    <div class="pr-name">@(string.IsNullOrWhiteSpace(p.PaymentsNote) ? "Ödeme" : p.PaymentsNote)</div>
                    <span class="pr-method">@PayMethodLabel(p.PaymentsMethod)</span>
                    <span class="pr-amount">₺@p.PaymentsAmount.ToString("N2")</span>
                </div>
            }
        }
        <div class="pay-actions">
            @if (isOpen) { <button class="btn-pay" onclick="openModal('payModal')">💳 Ödeme Al</button> }
            else         { <div style="text-align:center;padding:10px;color:#22c55e;font-weight:700;font-size:14px">✅ Adisyon Kapatıldı</div> }
        </div>
    </div>

</div>

@* ═══════════════════════════════════════════════════════════════
   ÜRÜN EKLE MODAL
   ═══════════════════════════════════════════════════════════════ *@
<div class="modal-overlay" id="addItemModal">
    <div class="add-modal">
        <div class="add-modal-title" id="addItemTitle">Ürün Ekle</div>
        <div class="add-modal-sub"   id="addItemSub">Adet seçin</div>
        <form asp-controller="Orders" asp-action="AddItem" method="post" onsubmit="return true">
            @Html.AntiForgeryToken()
            <input type="hidden" name="orderId"    value="@Model.OrderId" />
            <input type="hidden" name="menuItemId" id="addItemId" />
            <input type="hidden" name="quantity"   id="addItemQtyHidden" value="1" />
            <div class="form-group">
                <label class="form-label">Adet</label>
                <div class="qty-control">
                    <button type="button" class="qty-btn minus" onclick="changeAddQty(-1)">−</button>
                    <div class="qty-display" id="addItemQtyDisplay">1</div>
                    <button type="button" class="qty-btn plus"  onclick="changeAddQty(1)">+</button>
                </div>
                <div class="qty-line-total" id="addItemLineTotal">₺0,00</div>
            </div>
            <div class="form-group">
                <label class="form-label">Not (opsiyonel)</label>
                <input class="form-control" name="note" id="addItemNote" placeholder="Az pişmiş, acısız..." maxlength="200" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ghost"   onclick="closeModal('addItemModal')">İptal</button>
                <button type="submit" class="btn-primary" id="addItemSubmitBtn">Ekle (1 adet)</button>
            </div>
        </form>
    </div>
</div>

@* ═══════════════════════════════════════════════════════════════
   ÖDEME MODAL — YATAY, SABİT YÜKSEKLİK, SCROLL YOK
   ═══════════════════════════════════════════════════════════════ *@
<div class="modal-overlay" id="payModal">
    <div class="pay-modal-wide">

        <div class="pay-modal-header">
            <h2>💳 Ödeme Al</h2>
            <p>Sol taraftan ürün seçin ya da tutarı doğrudan girin</p>
        </div>

        <div class="pay-modal-body">

            @* SOL: Her satır tek satır — [AD] [FİYAT/ad] [− qty +] [toplam] *@
            <div class="pm-items-col">
                <div class="pm-items-head">🧾 Ürün Seç → Tutara Aktar</div>
                <div class="pm-items-list">
                    @foreach (var item in activeItems)
                    {
                        bool allPaid = item.PaidQuantity >= item.OrderItemQuantity;
                        int  maxSel  = item.RemainingQuantity;
                        <div class="pisel-row @(allPaid ? "all-paid" : "")"
                             data-item-id="@item.OrderItemId"
                             data-max-qty="@maxSel"
                             data-unit-price="@item.OrderItemUnitPrice.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)">

                            @* Ürün adı *@
                            <div class="pisel-name">
                                @item.MenuItem?.MenuItemName
                                @if (allPaid) { <span style="color:#22c55e;font-size:10px"> ✓</span> }
                            </div>

                            @* Birim fiyat ve kalan adet — orta sütun *@
                            <div class="pisel-uprice">
                                ₺@item.OrderItemUnitPrice.ToString("N2")/ad
                                @if (!allPaid) { <span style="display:block;font-size:10px">@maxSel kaldı</span> }
                            </div>

                            @* Adet kontrolü *@
                            <div class="pisel-ctrl">
                                <button type="button" class="pisel-minus" onclick="piselChange(@item.OrderItemId,-1)" id="pisel-minus-@item.OrderItemId" style="opacity:.3">−</button>
                                <span class="pisel-qty" id="pisel-qty-@item.OrderItemId">0</span>
                                <button type="button" class="pisel-plus"  onclick="piselChange(@item.OrderItemId,1)"  id="pisel-plus-@item.OrderItemId"  style="@(allPaid?"opacity:.3":"")">+</button>
                            </div>

                            @* Satır toplamı *@
                            <div class="pisel-sub" id="pisel-sub-@item.OrderItemId">—</div>
                        </div>
                    }
                </div>
                <div class="pm-items-footer">
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;font-weight:700">Seçilen Toplam</div>
                        <div class="pisel-total-val" id="piselTotalVal">₺0,00</div>
                    </div>
                    <button type="button" class="pisel-apply-btn" id="piselApplyBtn" onclick="applyPisel()" disabled>
                        Tutara Aktar →
                    </button>
                </div>
            </div>

            @* SAĞ: Form — scroll yok, kompakt *@
            <div class="pm-form-col">
                <div class="pm-summary-box">
                    <div class="pm-sum-row"><span style="color:var(--text-muted)">Adisyon Toplamı</span><span>₺@Model.OrderTotalAmount.ToString("N2")</span></div>
                    <div class="pm-sum-row" id="pm-disc-row" style="display:none"><span style="color:#22c55e">İndirim</span><span id="pm-disc-val" style="color:#22c55e">−₺0,00</span></div>
                    <div class="pm-sum-div"></div>
                    <div class="pm-sum-row"><span style="color:var(--text-muted)">Daha önce ödenen</span><span style="color:#22c55e">₺@totalPaid.ToString("N2")</span></div>
                    <div class="pm-sum-row"><span style="font-weight:700">Kalan</span><span class="pm-sum-total" id="pm-remaining">₺@remaining.ToString("N2")</span></div>
                </div>

                <form asp-controller="Orders" asp-action="AddPayment" method="post" onsubmit="return syncPayForm()" id="payForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="orderId"           value="@Model.OrderId" />
                    <input type="hidden" name="paymentMethod"     id="selectedMethod" value="cash" />
                    <input type="hidden" name="paymentAmountStr"  id="paymentAmountStr" />
                    <input type="hidden" name="discountAmountStr" id="discountAmountStr" />
                    <div id="piselHiddenInputs"></div>

                    <div class="form-group">
                        <label class="form-label">Ödeyen (opsiyonel)</label>
                        <input class="form-control" name="payerName" placeholder="Ali Yılmaz" maxlength="100" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ödeme Yöntemi *</label>
                        <div class="method-grid">
                            <button type="button" class="method-btn active" onclick="selectMethod(this,'cash')">💵 Nakit</button>
                            <button type="button" class="method-btn" onclick="selectMethod(this,'credit_card')">💳 Kredi Kartı</button>
                            <button type="button" class="method-btn" onclick="selectMethod(this,'debit_card')">🏦 Banka Kartı</button>
                            <button type="button" class="method-btn" onclick="selectMethod(this,'other')">🔄 Diğer</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">İndirim Tutarı</label>
                        <div class="discount-row">
                            <input class="form-control" id="discountDisplay" type="text" inputmode="decimal" placeholder="0" oninput="updateRemaining()" />
                            <span class="discount-label" id="disc-lbl" style="display:none">Net: ₺<span id="net-amount">0</span></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ödeme Tutarı *</label>
                        <input class="form-control" id="payAmountDisplay" type="text" inputmode="decimal" placeholder="0,00" oninput="updateChange()" />
                        <span class="form-error" id="err-amount">Geçerli bir tutar giriniz.</span>
                        @* Kalan tutarı doldur — belirgin yeşil buton *@
                        <button type="button" class="fill-remaining-btn" onclick="fillRemaining()">
                            <span>✓ Kalan tutarı doldur</span>
                            <span class="fill-amount" id="fillAmountLabel">₺@remaining.ToString("N2")</span>
                        </button>
                    </div>

                    <div id="changeRow" class="form-group" style="display:none">
                        <label class="form-label">Para Üstü</label>
                        <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:#22c55e;padding:2px 0" id="changeDisplay">₺0,00</div>
                    </div>
                </form>
            </div>

        </div>

        <div class="pay-modal-actions">
            <button type="button" class="btn-ghost"   onclick="closeModal('payModal')">İptal</button>
            <button type="button" class="btn-primary" onclick="document.getElementById('payForm').requestSubmit()">💾 Ödemeyi Kaydet</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/Views/Home/Detail.js" asp-append-version="true"></script>
}
