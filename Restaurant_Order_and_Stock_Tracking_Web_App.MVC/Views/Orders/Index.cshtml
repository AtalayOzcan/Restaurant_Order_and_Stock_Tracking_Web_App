@using Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models
@{
    ViewData["Title"] = "Siparişler";
    var activeOrders = (List<Order>)ViewBag.ActiveOrders;
    var pastOrders = (List<Order>)ViewBag.PastOrders;
    var activeTab = ViewData["ActiveTab"]?.ToString() ?? "active";

    // Dakika hesapla
    int MinutesOpen(DateTime openedAt) =>
        (int)(DateTime.UtcNow - openedAt).TotalMinutes;

    // Ödeme yöntemi
    string PayMethod(int m) => m switch { 1 => "💳 Kart", _ => "💵 Nakit" };

    // Sipariş kalemleri özet
    string ItemsSummary(ICollection<OrderItem> items) =>
        string.Join(", ", items
            .Where(i => i.OrderItemStatus != "cancelled")
            .Select(i => $"{i.MenuItem?.MenuItemName} ×{i.OrderItemQuantity}"));
}

@section Styles {
    <style>
        /* Tab bar */
        .tab-bar {
            display: flex;
            gap: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px;
            width: fit-content;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 8px 20px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-muted);
            border: none;
            background: none;
            font-family: 'DM Sans',sans-serif;
            transition: all .15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .tab-btn.active {
                background: var(--accent);
                color: #fff;
            }

            .tab-btn .tab-count {
                font-size: 10px;
                background: rgba(255,255,255,.2);
                padding: 1px 6px;
                border-radius: 20px;
            }

            .tab-btn:not(.active) .tab-count {
                background: var(--surface2);
                color: var(--text-muted);
            }

        /* Özet bar */
        .summary-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 22px;
            flex-wrap: wrap;
        }

        .summary-chip {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 130px;
        }

        .chip-icon {
            font-size: 22px;
        }

        .chip-val {
            font-family: 'Syne',sans-serif;
            font-size: 22px;
            font-weight: 700;
        }

        .chip-lbl {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 1px;
        }

        /* Kart grid */
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(290px,1fr));
            gap: 14px;
        }

        /* Sipariş kartı */
        .order-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform .15s, box-shadow .15s;
        }

            .order-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 28px rgba(0,0,0,.35);
            }

            .order-card.overdue {
                border-color: rgba(239,68,68,.35);
            }

        .card-head {
            padding: 13px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .card-num {
            font-family: 'Syne',sans-serif;
            font-size: 15px;
            font-weight: 800;
        }

        .card-head-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-body {
            padding: 13px 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

            .card-meta strong {
                color: var(--text);
            }

            .card-meta span {
                color: var(--text-muted);
            }

        .items-box {
            background: var(--surface2);
            border-radius: 9px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .item-name {
            color: var(--text-muted);
        }

        .item-price {
            font-weight: 600;
            color: var(--text);
        }

        .card-foot {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-total {
            font-family: 'Syne',sans-serif;
            font-size: 19px;
            font-weight: 800;
            color: var(--accent);
        }

        .card-actions {
            display: flex;
            gap: 6px;
        }

        .btn-detail {
            padding: 6px 12px;
            border-radius: 7px;
            border: 1px solid var(--border);
            background: none;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'DM Sans',sans-serif;
            transition: all .15s;
        }

            .btn-detail:hover {
                color: var(--text);
                border-color: var(--text-muted);
            }

        .btn-close {
            padding: 6px 12px;
            border-radius: 7px;
            border: 1px solid rgba(34,197,94,.4);
            background: none;
            color: #22c55e;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'DM Sans',sans-serif;
            transition: all .15s;
        }

            .btn-close:hover {
                background: rgba(34,197,94,.1);
            }

        /* Badge'ler */
        .status-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: .05em;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 20px;
        }

        .s-open {
            background: var(--accent-glow);
            color: var(--accent);
        }

        .s-preparing {
            background: rgba(234,179,8,.12);
            color: #eab308;
        }

        .s-served {
            background: rgba(34,197,94,.12);
            color: #22c55e;
        }

        .s-paid {
            background: rgba(34,197,94,.12);
            color: #22c55e;
        }

        .s-cancelled {
            background: rgba(239,68,68,.12);
            color: #ef4444;
        }

        .time-badge {
            font-size: 10px;
            background: var(--surface2);
            border: 1px solid var(--border);
            padding: 3px 8px;
            border-radius: 20px;
            color: var(--text-muted);
            white-space: nowrap;
        }

            .time-badge.hot {
                border-color: rgba(239,68,68,.4);
                color: #f87171;
                background: rgba(239,68,68,.08);
            }

        /* Geçmiş: ödeme yöntemi */
        .pay-method {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Boş durum */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Geçmiş tarih ayırıcı */
        .date-separator {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            letter-spacing: .06em;
            text-transform: uppercase;
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            grid-column: 1/-1;
        }

            .date-separator::before, .date-separator::after {
                content: '';
                flex: 1;
                height: 1px;
                background: var(--border);
            }

        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            border: 1px solid;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-success {
            background: rgba(34,197,94,.1);
            border-color: rgba(34,197,94,.3);
            color: #22c55e;
        }

        .alert-error {
            background: rgba(239,68,68,.1);
            border-color: rgba(239,68,68,.3);
            color: #ef4444;
        }

        @@media(max-width:600px) {
            .orders-grid {
                grid-template-columns: 1fr;
            }

            .summary-bar {
                gap: 8px;
            }
        }
    </style>
}

@* Alerts *@
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">✅ @TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-error">❌ @TempData["Error"]</div>
}

@* Page Header *@
<div class="page-header">
    <div>
        <h1 class="page-title">Siparişler</h1>
        <p class="page-sub">Aktif adisyonlar ve geçmiş siparişler</p>
    </div>
</div>

@* Özet Bar *@
<div class="summary-bar">
    <div class="summary-chip">
        <div class="chip-icon">🧾</div>
        <div>
            <div class="chip-val">@activeOrders.Count</div>
            <div class="chip-lbl">Aktif Adisyon</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">💰</div>
        <div>
            <div class="chip-val" style="color:var(--accent)">
                ₺@activeOrders.Sum(o => o.OrderTotalAmount).ToString("N0")
            </div>
            <div class="chip-lbl">Açık Adisyon Toplamı</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">✅</div>
        <div>
            <div class="chip-val" style="color:#22c55e">@pastOrders.Count(o => o.OrderStatus == "paid")</div>
            <div class="chip-lbl">Bugün Tamamlanan</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">📈</div>
        <div>
            <div class="chip-val" style="color:#22c55e">
                ₺@pastOrders.Where(o => o.OrderStatus == "paid").Sum(o => o.OrderTotalAmount).ToString("N0")
            </div>
            <div class="chip-lbl">Gün İçi Toplam Kazanç</div>
        </div>
    </div>
</div>

@* Tab Bar *@
<div class="tab-bar">
    <button class="tab-btn @(activeTab == "active" ? "active" : "")"
            onclick="switchTab('active', this)">
        Aktif
        <span class="tab-count">@activeOrders.Count</span>
    </button>
    <button class="tab-btn @(activeTab == "past" ? "active" : "")"
            onclick="switchTab('past', this)">
        Geçmiş
        <span class="tab-count">@pastOrders.Count</span>
    </button>
</div>

@* ── AKTİF SİPARİŞLER ── *@
<div id="tabActive" class="@(activeTab == "active" ? "" : "d-none")">
    @if (!activeOrders.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">🧾</div>
            <p>Şu an aktif sipariş yok.</p>
            <p style="margin-top:6px;font-size:12px">Masalar sayfasından yeni adisyon açabilirsiniz.</p>
        </div>
    }
    else
    {
        <div class="orders-grid">
            @foreach (var order in activeOrders)
            {
                var minutes = MinutesOpen(order.OrderOpenedAt);
                var isHot = minutes > 30;
                var summary = ItemsSummary(order.OrderItems);

                // Baskın durum
                var dominantStatus = order.OrderItems.Any()
                ? order.OrderItems
                .Where(i => i.OrderItemStatus != "cancelled")
                .GroupBy(i => i.OrderItemStatus)
                .OrderByDescending(g => g.Count())
                .First().Key
                : "open";

                string BadgeClass(string s) => s switch
                {
                                "preparing" => "s-preparing",
                                "served" => "s-served",
                    _ => "s-open"
                };

                string BadgeLabel(string s) => s switch
                {
                                "preparing" => "Hazırlanıyor",
                                "served" => "Servis Edildi",
                    _ => "Açık"
                };

                <div class="order-card @(isHot ? "overdue" : "")">
                    <div class="card-head">
                        <span class="card-num">#@order.OrderId</span>
                        <div class="card-head-right">
                            <span class="time-badge @(isHot ? "hot" : "")">
                                ⏱ @minutes dk
                            </span>
                            <span class="status-badge @BadgeClass(dominantStatus)">
                                @BadgeLabel(dominantStatus)
                            </span>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="card-meta">
                            🪑 <strong>@order.Table?.TableName</strong>
                            <span>·</span>
                            <span>👤 @order.OrderOpenedBy</span>
                        </div>

                        <div class="items-box">
                            @foreach (var item in order.OrderItems.Where(i => i.OrderItemStatus != "cancelled"))
                            {
                                <div class="item-row">
                                    <span class="item-name">@item.MenuItem?.MenuItemName ×@item.OrderItemQuantity</span>
                                    <span class="item-price">₺@item.OrderItemLineTotal.ToString("N0")</span>
                                </div>
                            }
                        </div>

                        @if (!string.IsNullOrWhiteSpace(order.OrderNote))
                        {
                            <div style="font-size:11px;color:var(--text-muted);background:var(--surface2);border-radius:7px;padding:7px 10px;">
                                📝 @order.OrderNote
                            </div>
                        }
                    </div>

                    <div class="card-foot">
                        <span class="card-total">₺@order.OrderTotalAmount.ToString("N0")</span>
                        <div class="card-actions">
                            <a asp-controller="Orders" asp-action="Detail"
                               asp-route-id="@order.OrderId"
                               class="btn-detail">Detay →</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* ── GEÇMİŞ SİPARİŞLER ── *@
<div id="tabPast" class="@(activeTab == "past" ? "" : "d-none")">
    @if (!pastOrders.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">📋</div>
            <p>Henüz tamamlanmış sipariş yok.</p>
        </div>
    }
    else
    {
        <div class="orders-grid">
            @foreach (var order in pastOrders)
            {
                var payment = order.Payments?.FirstOrDefault();
                var closedMins = order.OrderClosedAt.HasValue
                ? (int)(order.OrderClosedAt.Value - order.OrderOpenedAt).TotalMinutes
                : 0;

                <div class="order-card">
                    <div class="card-head">
                        <span class="card-num">#@order.OrderId</span>
                        <div class="card-head-right">
                            <span class="time-badge">@closedMins dk</span>
                            <span class="status-badge @(order.OrderStatus == "paid" ? "s-paid" : "s-cancelled")">
                                @(order.OrderStatus == "paid" ? "Ödendi" : "İptal")
                            </span>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="card-meta">
                            🪑 <strong>@order.Table?.TableName</strong>
                            <span>·</span>
                            <span>👤 @order.OrderOpenedBy</span>
                        </div>

                        <div class="items-box">
                            @foreach (var item in order.OrderItems.Where(i => i.OrderItemStatus != "cancelled"))
                            {
                                <div class="item-row">
                                    <span class="item-name">@item.MenuItem?.MenuItemName ×@item.OrderItemQuantity</span>
                                    <span class="item-price">₺@item.OrderItemLineTotal.ToString("N0")</span>
                                </div>
                            }
                        </div>

                        @if (payment != null)
                        {
                            <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px;">
                                <span class="pay-method">@PayMethod(payment.PaymentsMethod)</span>
                                @if (payment.PaymentsChangeGiven > 0)
                                {
                                    <span style="color:var(--text-muted)">Para üstü: ₺@payment.PaymentsChangeGiven.ToString("N0")</span>
                                }
                            </div>
                        }

                        @if (order.OrderClosedAt.HasValue)
                        {
                            <div style="font-size:11px;color:var(--text-muted)">
                                🕐 @order.OrderClosedAt.Value.ToLocalTime().ToString("dd MMM, HH:mm")
                            </div>
                        }
                    </div>

                    <div class="card-foot">
                        <span class="card-total" style="@(order.OrderStatus == "cancelled" ? "color:var(--text-muted)" : "")">
                            ₺@order.OrderTotalAmount.ToString("N0")
                        </span>
                        <a asp-controller="Orders" asp-action="Detail"
                           asp-route-id="@order.OrderId"
                           class="btn-detail">Detay →</a>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        function switchTab(name, btn) {
            // Tab butonları
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // İçerikler
            document.getElementById('tabActive').classList.add('d-none');
            document.getElementById('tabPast').classList.add('d-none');
            document.getElementById('tab' + (name === 'active' ? 'Active' : 'Past'))
                    .classList.remove('d-none');
        }

        // Alert otomatik kaybol
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(a => {
                a.style.transition = 'opacity .5s';
                a.style.opacity = '0';
                setTimeout(() => a.remove(), 500);
            });
        }, 3000);
    </script>
}