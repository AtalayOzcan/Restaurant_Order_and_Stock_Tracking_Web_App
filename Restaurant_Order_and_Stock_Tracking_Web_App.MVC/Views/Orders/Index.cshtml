@using Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models
@{
    ViewData["Title"] = "Siparişler";

    // Filtrelenmiş listeler (arama varsa bunlar filtrelidir)
    var activeOrders = (List<Order>)ViewBag.ActiveOrders;
    var pastOrders = (List<Order>)ViewBag.PastOrders;

    // Summary bar için FİLTRELENMEMİŞ gerçek günlük veriler
    var allActiveOrders = (List<Order>)ViewBag.AllActiveOrders;
    var allTodayRevenue = (decimal)ViewBag.AllTodayRevenue;
    var allTodayPaidCount = (int)ViewBag.AllTodayPaidCount;

    var activeTab = ViewData["ActiveTab"]?.ToString() ?? "active";
    var searchTable = ViewBag.SearchTable as string ?? "";

    int MinutesOpen(DateTime openedAt) => (int)(DateTime.UtcNow - openedAt).TotalMinutes;
    string PayMethod(int m) => m switch { 1 => "💳 Kredi Kartı", 2 => "💳 Banka Kartı", 3 => "🔄 Diğer", _ => "💵 Nakit" };
    var today = DateTime.Now.Date;
}

@section Styles {
    <link href="~/css/Views/Orders/Index.css" rel="stylesheet" asp-append-version="true" />
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">✅ @TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-error">❌ @TempData["Error"]</div>
}

<div class="page-header">
    <div>
        <h1 class="page-title">Siparişler</h1>
        <p class="page-sub">Aktif adisyonlar ve bugüne ait geçmiş siparişler</p>
    </div>
</div>

@* ── SUMMARY BAR — Aramayla değişmez, her zaman güncel gerçek veriler ── *@
<div class="summary-bar">
    <div class="summary-chip">
        <div class="chip-icon">🧾</div>
        <div style="min-width:0">
            <div class="chip-val">@allActiveOrders.Count</div>
            <div class="chip-lbl">Aktif Adisyon</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">💰</div>
        <div style="min-width:0">
            <div class="chip-val" style="color:var(--accent)">₺@allActiveOrders.Sum(o => o.OrderTotalAmount).ToString("N2")</div>
            <div class="chip-lbl">Açık Adisyon Toplamı</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">✅</div>
        <div style="min-width:0">
            <div class="chip-val" style="color:#22c55e">@allTodayPaidCount</div>
            <div class="chip-lbl">Bugün Tamamlanan</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">📈</div>
        <div style="min-width:0">
            <div class="chip-val" style="color:#22c55e">₺@allTodayRevenue.ToString("N2")</div>
            <div class="chip-lbl">Bugün Toplam Kazanç</div>
        </div>
    </div>
</div>

@* Toolbar: Tab + Arama *@
<div class="toolbar">
    <div class="tab-bar">
        @* onclick silindi, js-tab-btn sınıfı ve data-tab özelliği eklendi *@
        <button class="tab-btn js-tab-btn @(activeTab == "active" ? "active" : "")" data-tab="active">
            🔥 Aktif <span class="tab-count">@allActiveOrders.Count</span>
        </button>
        <button class="tab-btn js-tab-btn @(activeTab == "past" ? "active" : "")" data-tab="past">
            📋 Geçmiş <span class="tab-count">@pastOrders.Count</span>
        </button>
    </div>

    <div>
        <form method="get" action="/Orders" id="searchForm" style="display:flex;gap:8px;align-items:center;">
            <input type="hidden" name="tab" id="tabHidden" value="@activeTab" />
            <div class="search-wrap">
                <span class="search-icon">🔍</span>
                @* oninput silindi, JS tarafında ID üzerinden dinlenecek *@
                <input type="text" name="searchTable" id="searchInput" class="search-input"
                       placeholder="Masa adı ile ara…" value="@searchTable" />
                @if (!string.IsNullOrEmpty(searchTable))
                {
                    @* onclick silindi, id="btnClearSearch" eklendi *@
                    <button type="button" class="search-clear" id="btnClearSearch">✕</button>
                }
            </div>
        </form>
        @if (!string.IsNullOrEmpty(searchTable))
        {
            <div class="filter-notice">🎯 "@searchTable" masası filtreleniyor</div>
        }
    </div>
</div>

@* ── AKTİF SİPARİŞLER ── *@
<div id="tabActive" class="@(activeTab == "active" ? "" : "d-none")">
    @if (!activeOrders.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">🧾</div>
            <p>@(string.IsNullOrEmpty(searchTable) ? "Şu an aktif sipariş yok." : $"'{searchTable}' masasına ait aktif sipariş bulunamadı.")</p>
            <p style="margin-top:6px;font-size:12px">Masalar sayfasından yeni adisyon açabilirsiniz.</p>
        </div>
    }
    else
    {
        <div class="orders-grid">
            @foreach (var order in activeOrders)
            {
                var minutes = MinutesOpen(order.OrderOpenedAt);
                var isHot = minutes > 30;

                var dominantStatus = order.OrderItems.Any()
                ? order.OrderItems.Where(i => i.OrderItemStatus != "cancelled")
                .GroupBy(i => i.OrderItemStatus)
                .OrderByDescending(g => g.Count())
                .FirstOrDefault()?.Key ?? "open"
                : "open";

                string BadgeClass(string s) => s switch { "preparing" => "s-preparing", "served" => "s-served", _ => "s-open" };
                string BadgeLabel(string s) => s switch { "preparing" => "Hazırlanıyor", "served" => "Servis Edildi", _ => "Açık" };

                <div class="order-card @(isHot ? "overdue" : "")">
                    <div class="card-head">
                        <div class="card-head-left">
                            <span class="card-num">#@order.OrderId</span>
                            <span class="card-table-name">🪑 @order.Table?.TableName</span>
                        </div>
                        <div class="card-head-right">
                            <span class="time-badge @(isHot ? "hot" : "")">⏱ @minutes dk</span>
                            <span class="status-badge @BadgeClass(dominantStatus)">@BadgeLabel(dominantStatus)</span>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="card-meta">
                            👤 @order.OrderOpenedBy <span>·</span>
                            <span>🕐 @order.OrderOpenedAt.ToLocalTime().ToString("HH:mm")</span>
                        </div>

                        <div class="items-box">
                            @{
                                var visItems = order.OrderItems.Where(i => i.OrderItemStatus != "cancelled").ToList();
                                var showItems = visItems.Take(5).ToList();
                                var moreCount = visItems.Count - showItems.Count;
                            }
                            @foreach (var item in showItems)
                            {
                                <div class="item-row">
                                    <span class="item-name">@item.MenuItem?.MenuItemName ×@item.OrderItemQuantity</span>
                                    <span class="item-price">₺@item.OrderItemLineTotal.ToString("N2")</span>
                                </div>
                            }
                            @if (moreCount > 0)
                            {
                                <span class="item-more-badge">+ @moreCount kalem daha</span>
                            }
                        </div>

                        @if (!string.IsNullOrWhiteSpace(order.OrderNote))
                        {
                            <div class="note-box">📝 @order.OrderNote</div>
                        }
                    </div>

                    <div class="card-foot">
                        <span class="card-total">₺@order.OrderTotalAmount.ToString("N2")</span>
                        <div class="card-actions">
                            <a asp-controller="Orders" asp-action="Detail" asp-route-id="@order.OrderId" class="btn-detail">Detay →</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* ── GEÇMİŞ SİPARİŞLER ── *@
<div id="tabPast" class="@(activeTab == "past" ? "" : "d-none")">
    <div class="today-banner">
        📅 Gösterilen siparişler:
        <strong>@today.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"))</strong>
        tarihine ait — Gece yarısı 00:00'da otomatik sıfırlanır
    </div>

    @if (!pastOrders.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">📋</div>
            <p>@(string.IsNullOrEmpty(searchTable) ? "Bugüne ait tamamlanmış sipariş yok." : $"'{searchTable}' masasına ait bugün sipariş bulunamadı.")</p>
        </div>
    }
    else
    {
        // Masa birleştirmesi sonucu oluşan cancelled+toplam=0 adisyonları gizle
        var visiblePast = pastOrders
        .Where(o => !(o.OrderStatus == "cancelled" && o.OrderTotalAmount == 0))
        .ToList();

        var grouped = visiblePast
        .GroupBy(o => o.OrderOpenedAt.ToLocalTime().Date)
        .OrderByDescending(g => g.Key);

        <div class="orders-grid">
            @foreach (var group in grouped)
            {
                var groupDate = group.Key;
                var groupLabel = groupDate == today ? "Bugün" : groupDate.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"));
                var groupRevenue = group.Where(o => o.OrderStatus == "paid").Sum(o => o.OrderTotalAmount);

                <div class="date-group-header">
                    <div class="date-group-line"></div>
                    <span class="date-group-label">@groupLabel</span>
                    <span class="date-group-count">@group.Count() sipariş · ₺@groupRevenue.ToString("N2")</span>
                    <div class="date-group-line"></div>
                </div>

                @foreach (var order in group.OrderByDescending(o => o.OrderClosedAt))
                {
                    var payment = order.Payments?.FirstOrDefault();
                    var allPayments = order.Payments ?? new List<Payment>();
                    var closedMins = order.OrderClosedAt.HasValue
                    ? (int)(order.OrderClosedAt.Value - order.OrderOpenedAt).TotalMinutes : 0;

                    <div class="order-card @(order.OrderStatus == "paid" ? "card-paid" : "")">
                        <div class="card-head">
                            <div class="card-head-left">
                                <span class="card-num">#@order.OrderId</span>
                                <span class="card-table-name">🪑 @order.Table?.TableName</span>
                            </div>
                            <div class="card-head-right">
                                <span class="time-badge">@closedMins dk</span>
                                <span class="status-badge @(order.OrderStatus == "paid" ? "s-paid" : "s-cancelled")">
                                    @(order.OrderStatus == "paid" ? "Ödendi" : "İptal")
                                </span>
                            </div>
                        </div>

                        <div class="card-body">
                            <div class="card-meta">
                                👤 @order.OrderOpenedBy <span>·</span>
                                <span>🕐 @order.OrderOpenedAt.ToLocalTime().ToString("HH:mm")</span>
                            </div>

                            <div class="items-box">
                                @{
                                    var pastVisItems = order.OrderItems.Where(i => i.OrderItemStatus != "cancelled").ToList();
                                    var pastShowItems = pastVisItems.Take(5).ToList();
                                    var pastMoreCount = pastVisItems.Count - pastShowItems.Count;
                                }
                                @foreach (var item in pastShowItems)
                                {
                                    <div class="item-row">
                                        <span class="item-name">@item.MenuItem?.MenuItemName ×@item.OrderItemQuantity</span>
                                        <span class="item-price">₺@item.OrderItemLineTotal.ToString("N2")</span>
                                    </div>
                                }
                                @if (pastMoreCount > 0)
                                {
                                    <span class="item-more-badge">+ @pastMoreCount kalem daha</span>
                                }
                            </div>

                            @if (allPayments.Any())
                            {
                                <div class="pay-row">
                                    <span class="pay-method">@PayMethod(payment?.PaymentsMethod ?? 0)</span>
                                    @if (payment != null && payment.PaymentsChangeGiven > 0)
                                    {
                                        <span style="color:var(--text-muted);font-size:11px">Para üstü: ₺@payment.PaymentsChangeGiven.ToString("N2")</span>
                                    }
                                </div>
                            }

                            @if (order.OrderClosedAt.HasValue)
                            {
                                <div class="closed-time">🕐 Kapandı: @order.OrderClosedAt.Value.ToLocalTime().ToString("HH:mm")</div>
                            }
                        </div>

                        <div class="card-foot">
                            <span class="card-total @(order.OrderStatus == "cancelled" ? "muted" : "")">
                                ₺@order.OrderTotalAmount.ToString("N2")
                            </span>
                            <a asp-controller="Orders" asp-action="Detail" asp-route-id="@order.OrderId" class="btn-detail">Detay →</a>
                        </div>
                    </div>
                }
            }
        </div>
    }
</div>

@section Scripts {
    <script src="~/js/Views/Orders/Index.js" asp-append-version="true"></script>
}