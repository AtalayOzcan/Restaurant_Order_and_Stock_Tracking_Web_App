@model Restaurant_Order_and_Stock_Tracking_Web_App.MVC.ViewModels.Reports.ReportsDashboardViewModel
@{
    ViewData["Title"] = "Raporlar";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/css/Views/Reports/Index.css" rel="stylesheet" asp-append-version="true" />
}

<div class="rpt-page-header">
    <div>
        <h1>📈 Raporlar Paneli</h1>
        <div class="sub">Son güncelleme: @Model.LastRefreshedAt.ToString("dd.MM.yyyy HH:mm")</div>
    </div>
    <button class="rpt-refresh-btn" onclick="location.reload()">🔄 Yenile</button>
</div>

<!-- ── KPI Kartları ── -->
<div class="kpi-grid">
    <a class="kpi-card kpi-accent" href="/Reports/Sales?preset=today">
        <div class="kpi-icon">💰</div>
        <div class="kpi-value">₺@Model.TodayGrossSales.ToString("N2")</div>
        <div class="kpi-label">Bugünkü Brüt Ciro</div>
    </a>
    <a class="kpi-card kpi-green" href="/Reports/Sales?preset=today">
        <div class="kpi-icon">🏦</div>
        <div class="kpi-value">₺@Model.TodayNetCollected.ToString("N2")</div>
        <div class="kpi-label">Bugünkü Tahsilat</div>
    </a>
    <a class="kpi-card @(Model.OpenOrderCount > 0 ? "kpi-amber" : "")" href="/Orders">
        <div class="kpi-icon">🧾</div>
        <div class="kpi-value">@Model.OpenOrderCount</div>
        <div class="kpi-label">Açık Adisyon</div>
    </a>
    <a class="kpi-card @(Model.CriticalStockCount > 0 ? "kpi-red" : "")" href="/Stock">
        <div class="kpi-icon">📦</div>
        <div class="kpi-value">@Model.CriticalStockCount</div>
        <div class="kpi-label">Kritik Stok Ürünü</div>
    </a>
    <a class="kpi-card kpi-blue" href="/Reports/CancelAndWaste?preset=today">
        <div class="kpi-icon">🗑️</div>
        <div class="kpi-value">₺@Model.TodayWasteAmount.ToString("N2")</div>
        <div class="kpi-label">Bugünkü Fire Tutarı</div>
    </a>
    <a class="kpi-card kpi-purple" href="/Reports/Table?preset=today">
        <div class="kpi-icon">⏱️</div>
        <div class="kpi-value">@Model.AvgOrderDurationMinutes.ToString("F0") dk</div>
        <div class="kpi-label">Ort. Adisyon Süresi</div>
    </a>
</div>

<!-- ── Chart + Kritik Stok ── -->
<div class="rpt-row">
    <div class="rpt-card">
        <div class="rpt-card-title">
            <span>📊 Bugünkü Saatlik Ciro</span>
            <a href="/Reports/Sales?preset=today">Detay →</a>
        </div>
        <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
    <div class="rpt-card">
        <div class="rpt-card-title">
            <span>🚨 Kritik Stok</span>
            <a href="/Stock">Tümünü Gör →</a>
        </div>
        @if (Model.CriticalStockItems.Any())
        {
            <table class="mini-table">
                <thead>
                    <tr>
                        <th>Ürün</th>
                        <th>Stok</th>
                        <th>Eşik</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.CriticalStockItems)
                    {
                        <tr>
                            <td>@item.ProductName</td>
                            <td><span class="badge-red">@item.CurrentStock</span></td>
                            <td>@item.CriticalThreshold</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="empty-state">✅ Kritik stok yok</div>
        }
    </div>
</div>

<!-- ── En Çok Satanlar ── -->
<div class="rpt-card">
    <div class="rpt-card-title">
        <span>🏆 Bugünün En Çok Satan 5 Ürünü</span>
        <a href="/Reports/Sales?preset=today">Satış Raporu →</a>
    </div>
    @if (Model.TopProductsToday.Any())
    {
        <table class="mini-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ürün</th>
                    <th>Kategori</th>
                    <th>Adet</th>
                    <th>Ciro</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int rank = 1;
                }
                @foreach (var p in Model.TopProductsToday)
                {
                    <tr>
                        <td style="color: var(--text-muted);">@rank</td>
                        <td>@p.ProductName</td>
                        <td style="color: var(--text-muted);">@p.CategoryName</td>
                        <td><span class="badge-amber">@p.Quantity</span></td>
                        <td>₺@p.Revenue.ToString("N2")</td>
                    </tr>
                    rank++;
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="empty-state">Bugün henüz satış yok.</div>
    }
</div>
<script id="hourlySalesData" type="application/json">
    @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.HourlySales))
</script>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/Views/Reports/Index.js" asp-append-version="true"></script>
}
