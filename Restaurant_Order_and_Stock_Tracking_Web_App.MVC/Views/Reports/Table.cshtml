@model Restaurant_Order_and_Stock_Tracking_Web_App.MVC.ViewModels.Reports.TableReportViewModel
@{
    ViewData["Title"] = "Masa Performans Raporu";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var f = Model.Filter;
}

@section Styles {
    <link href="~/css/Views/Reports/Table.css" rel="stylesheet" asp-append-version="true" />
}

<div class="rpt-page-header">
    <div>
        <h1>🪑 Masa Performans Raporu</h1>
        <div class="sub">@f.DisplayRange</div>
    </div>
</div>

<div class="filter-bar">
    <button class="preset-btn @(f.Preset == "today" ? "active" : "")" data-preset="today">Bugün</button>
    <button class="preset-btn @(f.Preset == "week" ? "active" : "")" data-preset="week">Son 7 Gün</button>
    <button class="preset-btn @(f.Preset == "month" ? "active" : "")" data-preset="month">Son 30 Gün</button>
    <button class="preset-btn @(f.Preset == "custom" ? "active" : "")" data-preset="custom">Özel</button>
    <div class="filter-sep"></div>
    <input type="date" id="dateFrom" class="filter-date" value="@f.From.ToString("yyyy-MM-dd")" style="display:@(f.Preset == "custom" ? "" : "none")" />
    <input type="date" id="dateTo" class="filter-date" value="@f.To.AddDays(-1).ToString("yyyy-MM-dd")" style="display:@(f.Preset == "custom" ? "" : "none")" />
    <button class="btn-csv" id="btnCsv">📥 CSV İndir</button>
</div>

<!-- ── Özet Kartlar ── -->
<div class="sum-grid">
    <div class="sum-card">
        <div class="sum-val">@Model.TotalOrders</div>
        <div class="sum-label">Toplam Adisyon</div>
    </div>
    <div class="sum-card">
        <div class="sum-val">@Model.AvgDuration.ToString("F0") dk</div>
        <div class="sum-label">Ortalama Süre</div>
    </div>
    <div class="sum-card">
        <div class="sum-val">@Model.BusiestHour:00</div>
        <div class="sum-label">En Yoğun Saat</div>
    </div>
</div>

<!-- ── Bar Chart ── -->
<div class="chart-card">
    <div class="chart-card-title">📊 Masa Bazlı Ciro Karşılaştırması</div>
    <div class="chart-container">
        <canvas id="tableRevenueChart"></canvas>
        <div class="loading-overlay" id="chartLoading">Yükleniyor…</div>
    </div>
</div>

<!-- ── Masa Tablosu ── -->
<div class="table-wrap">
    @if (Model.Tables.Any())
    {
        <table class="data-table">
            <thead>
                <tr>
                    <th>Masa</th>
                    <th>Adisyon Sayısı</th>
                    <th>Toplam Ciro</th>
                    <th>Ort. Süre</th>
                    <th>Ort. Sepet</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.Tables)
                {
                    <tr>
                        <td><strong>@t.TableName</strong></td>
                        <td><span class="pill-accent">@t.TotalOrders</span></td>
                        <td>₺@t.TotalRevenue.ToString("N2")</td>
                        <td style="color:var(--text-muted);">@t.AvgDurationMinutes.ToString("F0") dk</td>
                        <td>₺@t.AvgOrderValue.ToString("N2")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="empty-state">Bu dönemde kapatılmış adisyon bulunamadı.</div>
    }
</div>
<script id="tableReportConfig" type="application/json">
    {
        "preset": "@f.Preset",
        "from": "@f.From.ToString("yyyy-MM-dd")",
        "to": "@f.To.AddDays(-1).ToString("yyyy-MM-dd")"
    }
</script>
<script id="tableChartData" type="application/json">
    @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tables.Select(t => new { name = t.TableName, revenue = t.TotalRevenue })))
</script>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/Views/Reports/Table.js" asp-append-version="true"></script>
}